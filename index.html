<html>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css" />
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-annotation/2.5.1/d3-annotation.min.js"></script>

  <style>
    .annotation-year-pagination,
    text.title {
      font-size: 0.8em;
    }

    div.tooltip {
      position: absolute;
      text-align: left;
      width: 200px;
      height: 100px;
      padding: 10px;
      font: 12px sans-serif;
      background: lightsteelblue;
      border: 0px;
      border-radius: 8px;
      pointer-events: none;
    }
  </style>

  <body onload="init()">
    <div class="w3-row">
      <div class="w3-container w3-blue">
        <h2>Superstore - Customer Analysis</h2>
      </div>
    </div>

    <br />

    <div class="w3-row">
      <div class="w3-third w3-container">
        <div class="w3-card-4">
          <svg id="year-pagination" width="400" height="100">
            <!-- <rect
                height="100"
                width="400"
                x="0"
                y="0"
                stroke="#000"
                fill="none"
              /> -->
            <text x="10" y="20" onclick="selectYear('prev')">&laquo;</text>
            <text x="30" y="20" onclick="selectYear('2019')">2019</text>
            <text x="80" y="20" onclick="selectYear('2020')">2020</text>
            <text x="130" y="20" onclick="selectYear('2021')">2021</text>
            <text x="180" y="20" onclick="selectYear('2022')">2022</text>
            <text x="230" y="20" onclick="selectYear('next')">&raquo;</text>
          </svg>
        </div>
      </div>

      <div class="w3-third w3-container">
        <div class="w3-card-4">
          <svg id="segment-filter" width="400" height="100">
            <!-- <rect
              height="100"
              width="400"
              x="0"
              y="0"
              stroke="#000"
              fill="none"
            /> -->
            <foreignObject x="10" y="5" width="400" height="100">
              <input
                type="checkbox"
                id="segment_all"
                name="segment_all"
                value="segment_all"
                checked="true"
              />
              <label for="segment_all">All</label><br />

              <input
                type="checkbox"
                id="segment_consumer"
                name="segment_consumer"
                value="segment_consumer"
                checked="true"
              />
              <label for="segment_consumer">Consumer</label><br />

              <input
                type="checkbox"
                id="segment_corporate"
                name="segment_corporate"
                value="segment_corporate"
                checked="true"
              />
              <label for="segment_corporate">Corporate</label><br />

              <input
                type="checkbox"
                id="segment_home_office"
                name="segment_home_office"
                value="segment_home_office"
                checked="true"
              />
              <label for="segment_home_office">Home Office</label><br />
            </foreignObject>
          </svg>
        </div>
      </div>

      <div class="w3-third w3-container">
        <div class="w3-card-4">
          <svg id="category-filter" width="400" height="100">
            <!-- <rect
              height="100"
              width="400"
              x="0"
              y="0"
              stroke="#000"
              fill="none"
            /> -->
            <foreignObject x="10" y="5" width="400" height="100">
              <input
                type="checkbox"
                id="category_all"
                name="category_all"
                value="category_all"
                checked="true"
              />
              <label for="category_all">All</label><br />

              <input
                type="checkbox"
                id="category_furniture"
                name="category_furniture"
                value="category_furniture"
                checked="true"
              />
              <label for="category_furniture">Furniture</label><br />

              <input
                type="checkbox"
                id="category_office_supplies"
                name="category_office_supplies"
                value="category_office_supplies"
                checked="true"
              />
              <label for="category_office_supplies">Office Supplies</label
              ><br />

              <input
                type="checkbox"
                id="category_technology"
                name="category_technology"
                value="category_technology"
                checked="true"
              />
              <label for="category_technology">Technology</label><br />
            </foreignObject>
          </svg>
        </div>
      </div>
    </div>

    <br />

    <div class="w3-row">
      <div class="w3-third w3-container">
        <div class="w3-card-4">
          <header class="w3-container w3-teal">
            <h6>Count of Customers</h6>
          </header>

          <div class="w3-container">
            <svg id="CountOfCustomersChart"></svg>
          </div>
        </div>
      </div>

      <div class="w3-third w3-container">
        <div class="w3-card-4">
          <header class="w3-container w3-teal">
            <h6>Sales</h6>
          </header>

          <div class="w3-container">
            <svg id="SalesChart"></svg>
          </div>
        </div>
      </div>

      <div class="w3-third w3-container">
        <div class="w3-card-4">
          <header class="w3-container w3-teal">
            <h6>Profit</h6>
          </header>

          <div class="w3-container">
            <svg id="ProfitChart"></svg>
          </div>
        </div>
      </div>
    </div>

    <br />

    <div class="w3-row">
      <div class="w3-container w3-light-grey">
        <div class="w3-panel">
          <a href="https://github.com/raja5-cs416dv/raja5-cs416dv.github.io"
            >Repository</a
          >
        </div>
      </div>
    </div>

    <script>
      let data = null;
      let selectedYear = null;
      const uniqueCustomerIds = [];
      const regions = ["West", "East", "Central", "South"];

      const chartData = {
        countOfCustomers: [],
        sales: [],
        profit: [],
      };

      async function init() {
        yearPaginationAnnotations();
        segmentFilterAnnotations();
        categoryFilterAnnotations();

        data = await d3.csv("./SampleSuperstoreOrders1.csv");
        console.log("Data loaded");

        selectYear("2019");
      }

      function yearPaginationAnnotations() {
        const annotations = [
          {
            type: d3.annotationCallout,
            note: {
              label:
                "Click Next or previous to see Customer Analysis over years, or select an year by clicking on it",
              title: "Slide Show",
              wrap: 300,
            },
            x: 50,
            y: 30,
            dy: 10,
            dx: 10,
          },
        ].map(function (d) {
          d.color = "grey";
          return d;
        });

        const makeAnnotations = d3
          .annotation()
          .type(d3.annotationLabel)
          .annotations(annotations);

        d3.select("#year-pagination")
          .append("g")
          .attr("class", "annotation-year-pagination")
          .call(makeAnnotations);
      }

      function segmentFilterAnnotations() {
        const annotations = [
          {
            type: d3.annotationCallout,
            note: {
              label: "Select one or more segments",
              title: "Segment Filter",
              wrap: 300,
            },
            x: 150,
            y: 50,
            dy: -5,
            dx: 10,
          },
        ].map(function (d) {
          d.color = "grey";
          return d;
        });

        const makeAnnotations = d3
          .annotation()
          .type(d3.annotationLabel)
          .annotations(annotations);

        d3.select("#segment-filter")
          .append("g")
          .attr("class", "annotation-year-pagination")
          .call(makeAnnotations);
      }

      function categoryFilterAnnotations() {
        const annotations = [
          {
            type: d3.annotationCallout,
            note: {
              label: "Select one or more categories",
              title: "Category Filter",
              wrap: 300,
            },
            x: 150,
            y: 50,
            dy: -5,
            dx: 10,
          },
        ].map(function (d) {
          d.color = "grey";
          return d;
        });

        const makeAnnotations = d3
          .annotation()
          .type(d3.annotationLabel)
          .annotations(annotations);

        d3.select("#category-filter")
          .append("g")
          .attr("class", "annotation-year-pagination")
          .call(makeAnnotations);
      }

      function selectYear(year) {
        switch (year) {
          case "prev":
            if (selectedYear <= 2019) {
              selectedYear = 2019;
            } else {
              selectedYear--;
            }

            break;
          case "next":
            if (selectedYear >= 2022) {
              selectedYear = 2022;
            } else {
              selectedYear++;
            }

            break;
          case "2019":
            selectedYear = 2019;
            break;
          case "2020":
            selectedYear = 2020;
            break;
          case "2021":
            selectedYear = 2021;
            break;
          case "2022":
            selectedYear = 2022;
            break;
        }

        console.log(`Selected year: ${selectedYear}`);

        processData();
        updateCharts();
      }

      function currencyFormatter(val) {
        const formatter = new Intl.NumberFormat("en-US", {
          style: "currency",
          currency: "USD",
          maximumFractionDigits: 0,
        });

        return formatter.format(val);
      }

      function formatAsPercent(val) {
        const formatter = new Intl.NumberFormat("default", {
          style: "percent",
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        });

        return formatter.format(val);
      }

      function regionIndex(d, data) {
        for (let i = 0; i < 4; i++) {
          if (data[i] === d) {
            return i;
          }
        }
      }

      function regionSummaryChartsTooltip(d, chartId) {
        let index = 0;
        let data = chartData.countOfCustomers;
        let customers = 0;
        let sales = 0;
        let profit = 0;
        let salesPerCustomer = 0;
        let profitRatio = 0;

        if (chartId === "#CountOfCustomersChart") {
          index = regionIndex(d, chartData.countOfCustomers);

          customers = d;
          sales = chartData.sales[index];
          profit = chartData.profit[index];
        }

        if (chartId === "#SalesChart") {
          index = regionIndex(d, chartData.sales);

          customers = chartData.countOfCustomers[index];
          sales = d;
          profit = chartData.profit[index];
        }

        if (chartId === "#ProfitChart") {
          index = regionIndex(d, chartData.profit);

          customers = chartData.countOfCustomers[index];
          sales = chartData.sales[index];
          profit = d;
        }

        salesPerCustomer = sales / customers;
        profitRatio = profit / sales;

        const htmlStr = `
          <div>
            Customers:      ${customers} </br>
            Sales:          ${currencyFormatter(sales)} </br>
            Profit:         ${currencyFormatter(profit)} </br>
            Sales/Customer: ${currencyFormatter(salesPerCustomer)} </br>
            Profit Ratio:   ${formatAsPercent(profitRatio)}
          </div>
        `;

        return htmlStr;
      }

      function updateCharts() {
        d3.select("#CountOfCustomersChart").html("");
        d3.select("#SalesChart").html("");
        d3.select("#ProfitChart").html("");

        updateRegionSummaryCharts(
          "#CountOfCustomersChart",
          chartData.countOfCustomers,
          (d) => {
            return d;
          }
        );

        updateRegionSummaryCharts("#SalesChart", chartData.sales, (d) => {
          return currencyFormatter(d);
        });
        updateRegionSummaryCharts("#ProfitChart", chartData.profit, (d) => {
          return currencyFormatter(d);
        });
      }

      function processData() {
        uniqueCustomerIds.length = 0;

        chartData.countOfCustomers.length = 0;
        chartData.sales.length = 0;
        chartData.profit.length = 0;

        let countOfCustomersSouth = 0;
        let countOfCustomersWest = 0;
        let countOfCustomersCentral = 0;
        let countOfCustomersEast = 0;

        let salesSouth = 0;
        let salesWest = 0;
        let salesCentral = 0;
        let salesEast = 0;

        let profitSouth = 0;
        let profitWest = 0;
        let profitCentral = 0;
        let profitEast = 0;

        data.forEach((e, i) => {
          const customerId = e["Customer ID"];
          const region = e.Region;
          const orderDate = e["Order Date"];
          const orderYear = new Date(orderDate).getFullYear();

          const origSalesStr = e.Sales.replace("$", "").replace(",", "").trim();
          let sales = parseFloat(origSalesStr);
          if (isNaN(sales)) {
            sales = 0.0;
          }

          let origProfitStr = e.Profit.replace("$", "").replace(",", "").trim();
          let positiveProfit = true;
          if (origProfitStr.startsWith("(")) {
            positiveProfit = false;
            origProfitStr = origProfitStr
              .replace("(", "")
              .replace(")", "")
              .trim();
          }

          let profit = parseFloat(origProfitStr);
          if (isNaN(profit)) {
            profit = 0;
          }

          if (!positiveProfit) {
            profit = -Math.abs(profit);
          }

          if (i === 0) {
            console.log(e);
            console.log(
              `Order date: ${orderDate}: Order year: ${orderYear}, Selected year: ${selectedYear}, Sales: ${sales}, Profit: ${profit}, Region: ${region}`
            );
          }

          if (orderYear !== selectedYear) {
            return;
          }

          const uniqueCustomerId = `${customerId}_${region}`;
          let uniqueCustomer = true;
          if (uniqueCustomerIds.includes(uniqueCustomerId)) {
            uniqueCustomer = false;
          }

          uniqueCustomerIds.push(uniqueCustomerId);

          switch (region) {
            case "South":
              if (uniqueCustomer) {
                countOfCustomersSouth++;
              }

              salesSouth += sales;
              profitSouth += profit;

              break;
            case "West":
              if (uniqueCustomer) {
                countOfCustomersWest++;
              }

              salesWest += sales;
              profitWest += profit;

              break;
            case "East":
              if (uniqueCustomer) {
                countOfCustomersEast++;
              }

              salesEast += sales;
              profitEast += profit;

              break;
            case "Central":
              if (uniqueCustomer) {
                countOfCustomersCentral++;
              }

              salesCentral += sales;
              profitCentral += profit;

              break;
          }
        });

        chartData.countOfCustomers.push(countOfCustomersWest);
        chartData.countOfCustomers.push(countOfCustomersEast);
        chartData.countOfCustomers.push(countOfCustomersCentral);
        chartData.countOfCustomers.push(countOfCustomersSouth);

        chartData.sales.push(salesWest);
        chartData.sales.push(salesEast);
        chartData.sales.push(salesCentral);
        chartData.sales.push(salesSouth);

        chartData.profit.push(profitWest);
        chartData.profit.push(profitEast);
        chartData.profit.push(profitCentral);
        chartData.profit.push(profitSouth);

        console.log(`Chart data: ${JSON.stringify(chartData)}`);
      }

      function updateRegionSummaryCharts(chartId, data, textFunc) {
        const width = 400;
        const height = 200;

        const svg = d3.select(chartId);

        svg.attr("width", width);
        svg.attr("height", height);

        const documentOutline = svg
          .append("rect")
          .attr("height", height)
          .attr("width", width)
          .attr("x", 0)
          .attr("y", 0)
          .style("stroke", "#000")
          .style("fill", "none");

        const margin = { top: 10, right: 100, bottom: 50, left: 50 };
        const plotHeight = height - margin.top - margin.bottom;
        const plotWidth = width - margin.left - margin.right;

        const plotOutline = svg
          .append("rect")
          .attr("x", margin.left)
          .attr("y", margin.top)
          .attr("height", plotHeight)
          .attr("width", plotWidth)
          .style("fill", "#00AFDB");

        // Add X Axis
        const x = d3
          .scaleLinear()
          .range([0, plotWidth])
          .domain([
            0,
            d3.max(data, function (d) {
              return d;
            }),
          ]);

        // Add Y Axis
        const y = d3
          .scaleBand()
          .range([0, plotHeight])
          .domain(regions)
          .padding(0.1);

        svg
          .append("g")
          .call(d3.axisLeft(y).tickSize(0))
          .attr("transform", `translate(${margin.left}, ${margin.top})`)
          .style("font-size", "12px")
          .style("font-weight", "light")
          .style("fill", "#000")
          .style("stroke", "none");

        documentOutline.remove();
        plotOutline.remove();
        y.call((g) => g.select(".domain").remove());

        // Add tooltip
        const tooltip = d3
          .select("body")
          .append("div")
          .attr("class", "tooltip")
          .style("opacity", 0);

        // Add bars
        const bars = svg
          .append("g")
          .attr("transform", `translate(${margin.left}, ${margin.top})`)
          .selectAll("rect")
          .data(data)
          .join("rect");

        bars.attr("height", y.bandwidth());
        bars.attr("fill", "#00AFDB").style("stroke", "#000");

        bars.attr("y", (data, i) => y(regions[i]));
        bars.attr("x", 0.5);

        bars.on("mouseover", function (event, d) {
          tooltip.transition().duration(200).style("opacity", 0.9);

          tooltip
            .html(regionSummaryChartsTooltip(d, chartId))
            .style("left", event.pageX + "px")
            .style("top", event.pageY - 28 + "px");

          d3.select(this).transition().attr("fill", "#eec42d");
        });

        bars.on("mouseout", function (d) {
          tooltip.transition().duration(500).style("opacity", 0);
          d3.select(this).transition().attr("fill", "#00AFDB");
        });

        bars
          .transition()
          .ease(d3.easeLinear)
          .duration(800)
          .attr("width", (data) => x(data))
          .delay((d, i) => i * 100);

        svg
          .selectAll(".text")
          .data(data)
          .enter()
          .append("text")
          .attr("x", function (d) {
            return x(d) + 85;
          })
          .attr("y", function (d, i) {
            return y(regions[i]) + 20;
          })
          .attr("dy", ".75em")
          .attr("font-family", "sans-serif")
          .attr("font-size", "14px")
          .attr("fill", "black")
          .attr("text-anchor", "middle")
          .text(textFunc);
      }
    </script>
  </body>
</html>
